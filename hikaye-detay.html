<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Siftah Hikaye Detayı</title>
    <link rel="icon" href="/images/navbar/logo.png" type="image/png" />
    <link rel="stylesheet" href="nav-footer.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap");

      body {
        background-color: #ffffff;
      }

      /* Başlıklar Modern Font */
      h1,
      h2,
      h3,
      h4,
      .sans-font {
        font-family: "Plus Jakarta Sans", sans-serif;
      }

      /* Hikaye Metni - Okunaklı Serif Font */
      .story-content {
        font-family: "Merriweather", serif;
        line-height: 1.8;
        font-size: 1.125rem; /* 18px */
        color: #334155;
      }

      /* Okuma İlerleme Çubuğu */
      #progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        height: 4px;
        background: linear-gradient(90deg, #ca8a04, #eab308);
        width: 0%;
        z-index: 9999;
        transition: width 0.1s;
      }

      /* Mobilde Kapak Resmi Ayarı */
      .hero-image {
        height: 50vh; /* Ekranın yarısı */
        object-fit: cover;
        width: 100%;
      }

      @media (min-width: 1024px) {
        .hero-image {
          height: 500px;
          border-radius: 1.5rem;
        }
      }

      /* İlk Harf Büyütme (Drop Cap) - Premium Dergi Havası */
      .drop-cap::first-letter {
        float: left;
        font-family: "Plus Jakarta Sans", sans-serif;
        font-weight: 800;
        font-size: 3.5rem;
        line-height: 0.8;
        padding-right: 12px;
        padding-top: 4px;
        color: #1e293b;
      }
    </style>
  </head>
  <body class="antialiased">
    <div id="progress-bar"></div>

    <div id="navbar"></div>
    <div id="toast-container"></div>

    <div
      id="loader"
      class="fixed inset-0 bg-white z-50 flex items-center justify-center"
    >
      <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"
      ></div>
    </div>

    <main class="pt-20 lg:pt-28 pb-20">
      <div class="container mx-auto px-4 max-w-4xl text-center mb-8 lg:mb-12">
        <a
          href="hikayemiz.html"
          class="inline-flex items-center text-gray-400 hover:text-gray-900 mb-6 transition sans-font text-sm font-medium"
        >
          <i class="fa-solid fa-arrow-left mr-2"></i> Hikayelere Dön
        </a>

        <h1
          id="storyTitle"
          class="text-3xl md:text-5xl font-extrabold text-gray-900 leading-tight mb-6"
        ></h1>

        <div
          class="flex flex-wrap items-center justify-center gap-4 lg:gap-8 text-sm text-gray-500 sans-font border-y border-gray-100 py-4 mb-8"
        >
          <div class="flex items-center gap-2" title="Yayınlanma Tarihi">
            <!-- <i class="fa-regular fa-calendar text-gray-400"></i> -->
            <span id="storyDate">...</span>
          </div>

          <div class="hidden sm:block w-px h-4 bg-gray-200"></div>

          <div class="flex items-center gap-2" title="Tahmini Okuma Süresi">
            <!-- <i class="fa-regular fa-clock text-gray-400"></i> -->
            <span id="readTime">... dk okuma</span>
          </div>

          <div class="hidden sm:block w-px h-4 bg-gray-200"></div>

          <div class="flex items-center gap-6">
            <div
              class="flex items-center gap-2 text-gray-600"
              title="Görüntülenme"
            >
              <i class="fa-regular fa-eye"></i>
              <span id="viewCountBadge" class="font-bold">0</span>
            </div>

            <div class="flex items-center gap-2 text-red-500" title="Beğeni">
              <i class="fa-solid fa-heart"></i>
              <span id="likeCountBadge" class="font-bold">0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="container mx-auto px-0 lg:px-4 max-w-6xl">
        <div class="mb-10 lg:mb-16">
          <img
            id="storyImage"
            src=""
            alt="Kapak"
            class="hero-image shadow-sm lg:shadow-2xl"
          />
        </div>

        <div class="flex flex-col lg:flex-row gap-12 px-4 lg:px-0">
          <article class="w-full lg:w-2/3">
            <div id="storyContent" class="story-content drop-cap mb-10"></div>

            <div
              class="border-t border-gray-100 pt-8 flex items-center justify-between"
            >
              <div class="flex gap-4">
                <button
                  id="likeBtn"
                  onclick="handleLike()"
                  class="flex items-center gap-2 px-6 py-3 bg-gray-50 rounded-full text-gray-600 hover:bg-red-50 hover:text-red-500 transition sans-font font-medium shadow-sm border border-gray-100"
                >
                  <i id="likeIcon" class="fa-regular fa-heart text-xl"></i>
                  <span id="likeBtnText" class="hidden sm:inline">Beğen</span>
                  <span id="likeCountBtn" class="ml-1 font-bold text-sm"
                    >(0)</span
                  >
                </button>
                <button
                  onclick="shareStory()"
                  class="flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition sans-font font-medium"
                >
                  <i class="fa-solid fa-share-nodes"></i>
                  <span class="hidden sm:inline">Paylaş</span>
                </button>
              </div>
            </div>
          </article>

          <aside class="w-full lg:w-1/3">
            <div class="sticky top-32">
              <div class="bg-gray-50 rounded-2xl p-6 border border-gray-100">
                <h4
                  class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 sans-font"
                >
                  YAZAR HAKKINDA
                </h4>

                <div class="flex items-center gap-4 mb-4">
                  <img
                    id="authorImage"
                    src=""
                    class="w-16 h-16 rounded-full object-cover border-2 border-white shadow-md cursor-pointer"
                    onclick="goToSeller()"
                  />
                  <div>
                    <h3
                      id="authorName"
                      class="font-bold text-lg text-gray-900 sans-font cursor-pointer hover:underline"
                      onclick="goToSeller()"
                    >
                      ...
                    </h3>
                    <div
                      id="authorBadge"
                      class="hidden items-center gap-1 text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-full w-max mt-1 sans-font"
                    >
                      <i class="fa-solid fa-medal"></i> Gold Satıcı
                    </div>
                  </div>
                </div>

                <p class="text-gray-600 text-sm mb-6 sans-font leading-relaxed">
                  Bu satıcının diğer ürünlerini ve hikayelerini keşfetmek için
                  mağazasını ziyaret edin.
                </p>

                <button
                  id="visitStoreBtn"
                  class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg shadow-slate-200 sans-font"
                >
                  Mağazayı Gör
                </button>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>

    <footer id="footer"></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>

    <script>
      const API_BASE_URL = "http://localhost:5000";
      let currentStoryId = null;
      let isLiked = false;
      let likeCount = 0;

      // --- TOAST BİLDİRİM FONKSİYONU ---
      function showToast(type, title, message) {
        const container =
          document.getElementById("toast-container") || createToastContainer();
        const toast = document.createElement("div");
        toast.className = `siftah-toast ${type}`;

        let icon =
          type === "success" ? "fa-check-circle" : "fa-circle-exclamation";
        if (type === "error") icon = "fa-circle-xmark";

        let color = type === "success" ? "#198754" : "#0ea5e9";
        if (type === "error") color = "#dc3545";

        toast.style.cssText = `
                background: white; border-left: 5px solid ${color}; padding: 15px 20px; 
                margin-bottom: 10px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
                display: flex; align-items: center; gap: 12px; min-width: 300px; animation: fadeIn 0.4s;
                position: fixed; top: 20px; right: 20px; z-index: 9999;
            `;

        toast.innerHTML = `
                <div class="p-2 rounded-full" style="color:${color}; background-color: ${color}20;">
                    <i class="fa-solid ${icon} text-xl"></i>
                </div>
                <div>
                    <h4 class="font-bold text-sm text-gray-900">${title}</h4>
                    <p class="text-xs text-gray-500">${message}</p>
                </div>
            `;

        container.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          toast.style.transition = "all 0.3s ease";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function createToastContainer() {
        const div = document.createElement("div");
        div.id = "toast-container";
        document.body.appendChild(div);
        return div;
      }

      // Okuma İlerleme Çubuğu
      window.onscroll = function () {
        let winScroll =
          document.body.scrollTop || document.documentElement.scrollTop;
        let height =
          document.documentElement.scrollHeight -
          document.documentElement.clientHeight;
        let scrolled = (winScroll / height) * 100;
        document.getElementById("progress-bar").style.width = scrolled + "%";
      };

      function fixImageUrl(dbPath) {
        if (!dbPath || dbPath === "undefined") return null;
        let cleanPath = dbPath.replace(/\\/g, "/");
        if (cleanPath.startsWith("http")) return cleanPath;
        if (cleanPath.includes("uploads/"))
          cleanPath = cleanPath.substring(cleanPath.indexOf("uploads/"));
        if (cleanPath.startsWith("/")) cleanPath = cleanPath.substring(1);
        return `${API_BASE_URL}/${cleanPath}`;
      }

      // Sayfa Yüklenince
      document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        currentStoryId = urlParams.get("id");

        if (!currentStoryId) {
          window.location.href = "hikayemiz.html";
          return;
        }

        // Görüntülenme Arttır
        incrementViewCount(currentStoryId);

        try {
          const res = await fetch(
            `${API_BASE_URL}/api/stories/${currentStoryId}`
          );
          if (!res.ok) throw new Error("Hikaye bulunamadı");

          const story = await res.json();
          renderStory(story);

          checkIfLiked(story.StoryLikes);
        } catch (error) {
          console.error(error);
          document.body.innerHTML = `
                    <div class="h-screen flex flex-col items-center justify-center">
                        <h2 class="text-2xl font-bold text-gray-800">Hikaye Bulunamadı</h2>
                        <a href="hikayemiz.html" class="mt-4 text-blue-600 hover:underline">Geri Dön</a>
                    </div>`;
        } finally {
          document.getElementById("loader").style.display = "none";
        }
      });

      async function incrementViewCount(id) {
        const viewedKey = `viewed_story_${id}`;
        if (!sessionStorage.getItem(viewedKey)) {
          try {
            await fetch(`${API_BASE_URL}/api/stories/view/${id}`, {
              method: "POST",
            });
            sessionStorage.setItem(viewedKey, "true");
          } catch (e) {
            console.log("Sayaç hatası", e);
          }
        }
      }

      function renderStory(story) {
        const seller = story.User || {};
        currentSellerId = seller.id;

        document.title = `${story.title} - Siftah`;
        document.getElementById("storyTitle").textContent = story.title;

        const date = new Date(story.createdAt).toLocaleDateString("tr-TR", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        document.getElementById(
          "storyDate"
        ).innerHTML = `<i class="fa-regular fa-calendar mr-1"></i> ${date}`;

        const words = story.content.split(/\s+/).length;
        const minutes = Math.ceil(words / 200);
        document.getElementById(
          "readTime"
        ).innerHTML = `<i class="fa-regular fa-clock mr-1"></i> ${minutes} dk okuma`;

        const imgUrl =
          fixImageUrl(story.coverImage) ||
          "https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=2070&auto=format&fit=crop";
        document.getElementById("storyImage").src = imgUrl;

        // İçerik Formatlama
        const formattedContent = story.content
          .split("\n")
          .map((para) => {
            if (para.trim().length > 0) return `<p class="mb-4">${para}</p>`;
            return "";
          })
          .join("");
        document.getElementById("storyContent").innerHTML = formattedContent;

        // Yazar
        const sellerName = seller.brandName || seller.name || "Siftah Satıcısı";
        document.getElementById("authorName").textContent = sellerName;
        document.getElementById("authorImage").src =
          fixImageUrl(seller.profileImage) ||
          `https://ui-avatars.com/api/?name=${encodeURIComponent(
            sellerName
          )}&background=random&color=fff`;

        if (seller.isApproved) {
          document.getElementById("authorBadge").classList.remove("hidden");
          document.getElementById("authorBadge").classList.add("inline-flex");
        }

        document.getElementById("visitStoreBtn").onclick = () => {
          window.location.href = `magaza-detay.html?sellerId=${seller.id}`;
        };

        // İstatistikler
        document.getElementById("viewCountBadge").textContent =
          story.viewCount || 0;
        likeCount = story.StoryLikes ? story.StoryLikes.length : 0;
        updateLikeUI();
      }

      function checkIfLiked(likesArray) {
        const userToken = localStorage.getItem("user");
        if (!userToken) return;
        const user = JSON.parse(userToken);
        if (likesArray && likesArray.some((like) => like.userId === user.id)) {
          isLiked = true;
          updateLikeUI();
        }
      }

      function updateLikeUI() {
        const icon = document.getElementById("likeIcon");
        const btnText = document.getElementById("likeBtnText");
        const countBadge = document.getElementById("likeCountBadge");
        const countBtn = document.getElementById("likeCountBtn");

        countBadge.textContent = likeCount;
        countBtn.textContent = `(${likeCount})`;

        if (isLiked) {
          icon.classList.remove("fa-regular");
          icon.classList.add("fa-solid");
          icon.style.color = "#ef4444";
          btnText.textContent = "Beğendin";
          btnText.classList.add("text-red-500");
        } else {
          icon.classList.remove("fa-solid");
          icon.classList.add("fa-regular");
          icon.style.color = "";
          btnText.textContent = "Beğen";
          btnText.classList.remove("text-red-500");
        }
      }

      async function handleLike() {
        const token = localStorage.getItem("token");
        if (!token) {
          showToast(
            "warning",
            "Giriş Yapın",
            "Beğenmek için giriş yapmalısınız."
          );
          return;
        }

        // Optimistik UI
        if (isLiked) {
          isLiked = false;
          likeCount--;
        } else {
          isLiked = true;
          likeCount++;
        }
        updateLikeUI();

        try {
          const res = await fetch(
            `${API_BASE_URL}/api/stories/like/${currentStoryId}`,
            {
              method: "POST",
              headers: { Authorization: "Bearer " + token },
            }
          );

          if (!res.ok) {
            if (isLiked) {
              isLiked = false;
              likeCount--;
            } else {
              isLiked = true;
              likeCount++;
            }
            updateLikeUI();
            showToast("error", "Hata", "İşlem gerçekleştirilemedi.");
          }
        } catch (e) {
          console.error(e);
          showToast("error", "Hata", "Bağlantı sorunu.");
        }
      }

      function shareStory() {
        if (navigator.share) {
          navigator
            .share({ title: document.title, url: window.location.href })
            .catch(console.error);
        } else {
          navigator.clipboard.writeText(window.location.href);
          showToast(
            "success",
            "Kopyalandı",
            "Hikaye bağlantısı panoya kopyalandı!"
          );
        }
      }
    </script>
  </body>
</html>
